#!/usr/bin/env bash

set -euo pipefail

METADATA_URL="http://169.254.169.254/latest"

# Fetch instance role from EC2 metadata
echo "[*] Fetching EC2 instance role tag..."
TOKEN=$(curl -s -X PUT "${METADATA_URL}/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

ROLE=$(
  curl -s -H "X-aws-ec2-metadata-token: ${TOKEN}" \
    "${METADATA_URL}/meta-data/tags/instance/Role"
)

echo "[*] EC2 instance role: ${ROLE}"

if [[ "${ROLE}" == "k8s-control-plane" ]]; then
  echo "Checking control plane initialization..."
  if [ ! -f /etc/kubernetes/admin.conf ]; then
    echo "[+] Running kubeadm init..."
    kubeadm init --config="/{{ kubernetes_kubeadm_config_path }}" \
      --upload-certs \
      --node-name="{{ kubernetes_control_plane_host_name }}" |
      tee /root/kubeadm-init.out

    echo "[+] Install Cilium..."
    cilium install --version 1.17.4 --kubeconfig /etc/kubernetes/admin.conf

    echo "[+] Save join command to SSM..."
    WORKER_NODE_JOIN_COMMAND=$(kubeadm token create --ttl 0 --description "Auto-scaled nodes" --print-join-command)
    aws ssm put-parameter \
      --name "/k8s-homelab/worker-node-join-command" \
      --value "${WORKER_NODE_JOIN_COMMAND}" \
      --type "SecureString" \
      --overwrite

    echo "[+] Save control plane private IP to SSM..."
    CONTROL_PLANE_PRIVATE_IP=$(
      curl -s -H "X-aws-ec2-metadata-token: ${TOKEN}" \
        "${METADATA_URL}/meta-data/local-ipv4"
    )
    aws ssm put-parameter \
      --name "/k8s-homelab/control-plane-ip" \
      --value "${CONTROL_PLANE_PRIVATE_IP}" \
      --type "String" \
      --overwrite
  else
    echo "[~] control plane already initialized, skipping."
  fi
else
  echo "[!] Skipping Kubernetes init: instance role is not 'k8s-control-plane'."
fi
